<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>FindMyFriend</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><!-- jQuery-->
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css"><!-- jQuery Mobile-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script><!-- jQuery Mobile-->
        
        
    <script type="text/javascript">
        var etat={};
        
        var lastContactSelected=null;
       
        window.onload = function() {
            
            etat.myself={};
            etat.myself.login = {};
            etat.myself.nom = [];
            etat.connectedusers= [];
            
            
            //etat.connectedusers.status = 0;
            
            etat.view = null;//si il null c'est la page des utilisateur si non on affiche la bossole selon la login choisie
        
       
    //changer les etats des utilisateurs automatiquement avec  refreshall();
        var evt = new EventSource('/api/userstream');
            evt.addEventListener('userschanged',function(e) {
                //ATTENTION, data contient juste l'utilisateur qui a changé
                //ce n'est pas l'état complet
                console.log(e.data);
                refreshall();
               
            });
        }   
        
        function refreshall(){
            
            $.get("/api/currentstate",{},refreshallcallback);
            return;
            function refreshallcallback(data){
                etat=data;
                afficheToutLEtat();
            }
        }
         
      
       // afficher la liste des utilisateurs  
        function afficheToutLEtat() {
            var tbody = $("#userstbody"); 
            tbody.html('');  
           
            for (var i in etat.connectedusers) {
                var user = etat.connectedusers[i];
                var li=$("<li>");
                var a=$("<a>",{"onclick":"ShowPopup('"+user.login+"');",'id':"lien-"+user.login});
               a.text(user.login);
               li.append(a);
               tbody.append(li);
            }
            tbody.listview('refresh');
        }
        
        function ShowPopup(name){

         switch(etat.connectedusers[name].status){
             
            case 0: 
                $("#inv").show();
                $("#loc").hide();
                $("#acc").hide();
                $("#ign").hide();
                $("#fin").hide();
             break;
             
            case 1: 
                $("#inv").show();
                $("#loc").hide();
                $("#acc").hide();
                $("#ign").hide();
                $("#fin").hide();
             break;
             
            case 2:
                $("#inv").hide();
                $("#loc").hide();
                $("#acc").show();
                $("#ign").show();
                $("#fin").show();
             break;
             
            case 3:  
                $("#inv").hide();
                $("#loc").hide();
                $("#acc").hide();
                $("#ign").hide();
                $("#fin").show();
             break;
             
             case 4:  
                $("#inv").hide();
                $("#loc").show();
                $("#acc").hide();
                $("#ign").hide();
                $("#fin").show();
             break;
       
         }
          lastContactSelected=name;
          $("#popup").popup("open"); 
        }
       
        //$('#userstbody li:first-child a').addClass('ui-icon-user')
        
        function inviteClicked() {
            
            $.get("/api/invite",{user: lastContactSelected});
            $("#popup").popup("close");}// fermer le popup

        
         function finishClicked() {
            
            $.get("/api/finish",{user: lastContactSelected});
            $("#popup").popup("close");}
            
        
         function locationClicked() {
            
            $.get("/api/seelocation",{user: lastContactSelected}, LocationUser);
            $("#popup").popup("close");}
            
        
    /*   function LocationUser(event){
          var tbody = $("#loc"); 
          tbody.html('');
          
           
           if (!navigator.geolocation){
            tbody.append($("<p>").text("Geolocation is not supported by your browser"));
                return;}
                
          /* function success(position) {
                var latlng  = (position.coords.latitude,position.coords.longitude);
                /*var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;*/
               //output.innerHTML = '<p>Latitude is ' + latitude + '° <br>Longitude is ' + longitude + '°</p>';
           /*     tbody.append($("<p>").text(latlng));
               var img = new Image();
                img.src = "http://rlv.zcache.fr/fleche_noire_vers_le_haut_dicone_papier_a_lettre-r294a86433e2d4762b39bf0878f93d5d0_vg6ke_8byvr_512.jpg" :"+latitude+"," + longitude + "&zoom=13&size=300x300&sensor=false";
                tbody.(img);}*/
            
         /*   function error() {
               tbody.text("Unable to retrieve your location");
                      };   
            var p=$("<p>").text("Locating…");
            tbody.append(p);
            navigator.geolocation.getCurrentPosition(success, error);
             } */
       /*if(window.DeviceOrientationEvent) {
  window.addEventListener("deviceorientation", process, false);
} else {
  // Le navigateur ne supporte pas l'événement deviceorientation
}

function process(event) {
 var tbody = $("#loc"); 
  tbody.html('');
  var alpha = event.alpha;//z
  var beta = event.beta;//x
  var gamma = event.gamma;//y
  var ul=$("<ul>");
  var li=$("<li>").text(alpha);
  ul.append(li);
  //document.getElementById("log").innerHTML = "<ul><li>Alpha : " + alpha + "</li><li>Beta : " + beta + "</li><li>Gamma : " + gamma + "</li></ul>"; 
}

((x) => { for (g in x.groups) { console.log( x.students.filter( (s) => s.group == g ).map( (s) => s.nom + ' ' + s.prenom ).join(', ') + ': ' + x.groups[g].project ) } })(JSON.parse(document.body.textContent))
*/
      
        
    </script>
 
    </head>
    
    <body>

        <div  data-role="page" id="account">

            <p><h1>Welcome to your account {{ login }}</h1></p>

            <div data-role="collapsible">
                <h2>Contacts</h2>
                <ul  id= "userstbody" data-role="listview"></ul>
            </div>
            
            <div data-role="popup" id="popup" data-theme="b">
                <ul data-role="listview">
                    <li id="inv"><a onclick="inviteClicked()" data-role="button">Invite</a></li>
                    <li id="loc"><a onclick="locationClicked()" data-role="button">See location</a></li>
                    <li id="acc"><a onclick="accepterClicked()" data-role="button">Accepter</a></li>
                    <li id="fin"><a onclick="finishClicked()" data-role="button">Finish</a></li>
                    <li id="ign"><a href="#ingnorer" data-role="button">Ingnorer</a></li>
                </ul>
                
            </div>
            
            <div data-role="popup" id="popup1" data-theme="b">
                <ul data-role="listview">
                    <li><a onclick="invitationyes()" data-role="button">Accept</a></li>
                    <li><a href="#ref" data-role="button">Refuser</a></li>
                </ul>
                
            </div>
            <p><a href="/logout">logout</a></p>
        </div>
       
    
     <!-- See location  -->     
      <div data-role="page" id="see_location">
          <tbody id="bossole"></tbody>
          <a href="#account" data-role="button">EXIT</a>
      </div>
      
      <!-- Finish  -->     
      <div data-role="page" id="finish">
          <div data-rel="dialogue">
              <p>voulez vous arrêter le partage</p>
                  <input type="submit" id="finish" value="Yes">
                  <a href="#account" data-role="button">Non</a>
          </div>
      </div>
 
    </body>
    
</html>