<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Liste des utilisateurs connectés</title>
        <style>
            .colorrect {
                display: inline-block;
                width: 2cm;
                height: 1ex;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> {# script pour utiliser JQuery#}
        <script type="text/javascript">
        
        window.onload = function() {
            //var button = document.getElementById("refreshBtn"); 
            //button.addEventListener("click", refreshUsers);  //6.5 activar el boton refresh
            //Option 1: 
            // On rafraîchit la liste des utilisateurs toutes les 10 secondes
            $("#refreshBtn").click(refreshUsers);  //equivalent JQuery question 6.5
           // setInterval('refreshUsers()',10000); 7.3 suprrimez le 10 sec et on fait les suivant:::
           
            var evt = new EventSource('/api/userstream');
            evt.addEventListener('userschanged',function(e) {
                console.log(e.data);
                updateUserlist(JSON.parse(e.data));
            });
            
            // 
            //ou encore mieux Option 2:
            // On laisse le serveur envoyer la liste des utilisateurs 
            //   via une EventSource seulement quand elle change
        }
        
        function refreshUsers() {
            //TODO: faire une requête AJAX à /api/userlist puis mettre à jour la page
            /*var xhr = new XMLHttpRequest();
            xhr.responseType = 'json';
            xhr.onload = function(){updateUserlist(xhr.response)};
            xhr.open ("GET","api/userlist",true);
            xhr.send();*/
            $.get("/api/userlist", {}, updateUserlist);
        }
        
        
        function updateUserlist(data) {
            var tbody = $("#userstbody"); //equivalent JQ     var tbody = document.getElementById("userstbody");
            tbody.html(''); //equivalent   tbody.innerHTML='';
            for (var i in data) {
                var user = data[i];
                
                var tr = $("<tr>"); //equivalent JQ    var tr = document.createElement('tr');
                var td = $("<td>"); //equvalent     var td = document.createElement('td');
                td.text(user.login);//equivalent    td.appendChild(document.createTextNode(user.login));
                tr.append(td); //equivalent Jquery    tr.appendChild(td);
                tbody.append(tr);
            }
        }
            
        </script>
    </head>
    <body>
        <h1>Liste des utilisateurs connectés -- Logged in as {{ login }}</h1>
        <a href="/logout">logout</a>
        <input type="button" id="refreshBtn" value="Rafraîchir"><br/>
        <table>
            <tr>
                <th>Login</th>
            </tr>
            <tbody id="userstbody"></tbody>
        </table>
    </body>
</html>